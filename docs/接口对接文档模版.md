# ğŸš€ æ¥å£å¯¹æ¥æŒ‡å—

æœ¬é¡¹ç›®çš„æ¥å£è®¾è®¡éµå¾ª **RESTful** è§„èŒƒï¼Œå¹¶å†…ç½®äº†ä¼ä¸šçº§çš„å®‰å…¨åŠ å›ºæ–¹æ¡ˆï¼ˆç­¾åéªŒè¯ã€å“åº”åŠ å¯†ã€Token è‡ªåŠ¨ç»­æœŸï¼‰ã€‚

## ä¸€ã€ åŸºç¡€ä¿¡æ¯

* **Base URL**: `https://api.yourdomain.com/api`
* **Content-Type**: `application/json`
* **èº«ä»½è®¤è¯**: ä½¿ç”¨ `Authorization: Bearer {token}` æ”¾å…¥ Headerã€‚

---

## äºŒã€ å®‰å…¨æ ¡éªŒé€»è¾‘ (Signature)

å½“æ¥å£è¦æ±‚ç­¾åéªŒè¯æ—¶ï¼Œå‰ç«¯å¿…é¡»åœ¨ Header ä¸­æºå¸¦ `x-sign` å’Œ `x-timestamp`ã€‚

### 1. ç­¾åæµç¨‹

1. è·å–å½“å‰ **UNIX æ—¶é—´æˆ³** (ç§’)ã€‚
2. å°†æ‰€æœ‰è¯·æ±‚å‚æ•° (Query + Body) æŒ‰ **é”®å(Key) å­—æ¯å‡åº** æ’åºã€‚
3. å°†æ’åºåçš„å‚æ•°åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ã€‚
4. æ‹¼æ¥å­—ç¬¦ä¸²ï¼š`å¾…ç­¾åä¸² = æ—¶é—´æˆ³ + å‚æ•°JSON`ã€‚
5. ä½¿ç”¨ **HMAC-SHA256** ç®—æ³•ï¼Œé…åˆ `APP_KEY` è®¡ç®—å“ˆå¸Œå€¼ã€‚

### 2. ä»£ç å‚è€ƒ (JavaScript)

```javascript
import CryptoJS from 'crypto-js';
import _ from 'lodash';

function getSignature(params, timestamp, appKey) {
  // 1. æ’åº
  const sortedParams = _.fromPairs(_.sortBy(_.toPairs(params), 0));
  // 2. æ‹¼æ¥
  const stringToSign = `${timestamp}${JSON.stringify(sortedParams)}`;
  // 3. è®¡ç®—
  return CryptoJS.HmacSHA256(stringToSign, appKey).toString(CryptoJS.enc.Hex);
}

```

---

## ä¸‰ã€ å“åº”æ ¼å¼ä¸æ•°æ®è§£å¯†

### 1. æ ‡å‡†å“åº”ç»“æ„

```json
{
  "msg": "success",
  "data": "U2FsdGVkX19v...", // å¦‚æœå¼€å¯äº† RETURN_ENCRYPTï¼Œè¿™é‡Œæ˜¯åŠ å¯†ä¸²
  "is_encrypted": true       // æ ‡è¯†æ˜¯å¦éœ€è¦è§£å¯†
}

```

### 2. è§£å¯†é€»è¾‘

å¦‚æœ `is_encrypted` ä¸º `true`ï¼Œè¯·ä½¿ç”¨ **AES-256-CBC** ç®—æ³•ï¼Œé…åˆ `APP_KEY` å’Œ `APP_IV` è§£å¯† `data` å­—æ®µã€‚

---

## å››ã€ Token æ— æ„Ÿç»­æœŸ (Silent Refresh)

ä¸ºäº†ä¿è¯ç”¨æˆ·ä½“éªŒï¼Œæ¡†æ¶æ”¯æŒæ— æ„Ÿç»­æœŸã€‚

1. å‰ç«¯å‘é€è¯·æ±‚ã€‚
2. è‹¥ Token å³å°†è¿‡æœŸï¼ŒæœåŠ¡ç«¯ä¼šåœ¨ **Response Headers** ä¸­é™„åŠ  `X-New-Token` å­—æ®µã€‚
3. å‰ç«¯ **å¿…é¡»** æ£€æŸ¥æ¯ä¸€æ¡å“åº”çš„ Headerï¼Œè‹¥å­˜åœ¨è¯¥å­—æ®µï¼Œè¯·ç«‹å³æ›¿æ¢æœ¬åœ°å­˜å‚¨çš„æ—§ Tokenã€‚

### Axios æ‹¦æˆªå™¨ç¤ºä¾‹

```javascript
axios.interceptors.response.use(response => {
  const newToken = response.headers['x-new-token'];
  if (newToken) {
    localStorage.setItem('token', newToken); // è‡ªåŠ¨æ›´æ–°æœ¬åœ° Token
  }
  return response;
});

```

---

## äº”ã€ ç½‘å…³é‰´æƒ (AppId / AppSecret)

é’ˆå¯¹ **Server-to-Server** æˆ–ç‰¹å®šå¼€æ”¾æ¥å£ï¼Œéœ€åœ¨ Header ä¸­ä¼ é€’ç½‘å…³å‡­è¯ï¼š

* **app-id**: åˆ†é…çš„ AppIDã€‚
* **app-secret**: åŠ¨æ€è®¡ç®—çš„å¯†æ–‡ã€‚è®¡ç®—å…¬å¼ï¼š`md5(md5(appId + timestamp) + rawSecret) + timestamp`ã€‚

---

## å…­ã€ é”™è¯¯ç è¯´æ˜

| çŠ¶æ€ç  | å«ä¹‰ | å¤„ç†å»ºè®® |
| --- | --- | --- |
| **401** | Token å¤±æ•ˆ / ç¼ºå¤± | è·³è½¬ç™»å½•é¡µ |
| **403** | ç­¾åéªŒè¯å¤±è´¥ / æƒé™ä¸è¶³ | æ£€æŸ¥ç­¾åç®—æ³•å’Œå¯†é’¥ |
| **422** | å‚æ•°æ ¡éªŒå¤±è´¥ | æ£€æŸ¥è¡¨å•å­—æ®µæ˜¯å¦ç¬¦åˆ rules() è¦æ±‚ |
| **500** | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | è”ç³»åç«¯å¼€å‘äººå‘˜ |

---

## ä¸ƒã€ è°ƒè¯•å»ºè®®

1. **å¼€å‘ç¯å¢ƒ**: åç«¯è‹¥å¼€å¯ `APP_DEBUG=true`ï¼Œå“åº”ç»“æœä¸­ä¼šåŒ…å« `stack` è°ƒè¯•ä¿¡æ¯ã€‚
2. **Mock æ•°æ®**: å»ºè®®ä½¿ç”¨ `Postman` é¢„å…ˆé…ç½® Pre-request Script æ¥è‡ªåŠ¨ç”Ÿæˆç­¾åã€‚